# Dify導入トレーニング - 3日目
## エージェント作成実習

---

## 📋 3日目の学習目標

この日の終わりまでに、以下のことができるようになります：
- 外部AIサービス（OpenAI等）をDifyに設定できる
- 基本的なチャットボットを作成できる
- 知識ベースを活用したエージェントを構築できる
- 実用的なビジネスエージェントを完成させる
- エージェントのテストと改善ができる

**重要：** 今日は段階的に機能を理解しながら、実用的なエージェントを作り上げます！

---

## 🔧 Phase 1: AI プロバイダーの設定

### 1.1 なぜ外部AIが必要なのか？

**Difyの仕組み理解：**
- **Dify本体**: AIアプリケーションのプラットフォーム
- **AIプロバイダー**: 実際のAI処理を行うサービス
- **関係性**: DifyがAIプロバイダーに処理を依頼し、結果を受け取る

```
ユーザー → Dify → AIプロバイダー（OpenAI等） → AI回答 → Dify → ユーザー
```

### 1.2 利用可能なAIプロバイダー

#### 主要なオプション
**有料・高性能:**
- **OpenAI**: GPT-4, GPT-3.5（推奨）
- **Anthropic**: Claude
- **Google**: Gemini

**無料・制限あり:**
- **OpenAI**: 無料枠（月$5相当）
- **Google**: Gemini無料版
- **Hugging Face**: オープンソースモデル

**今日の実習用推奨:**
OpenAI（設定が最も簡単で、日本語対応も優秀）

### 1.3 OpenAI APIキーの取得

#### Step 1: アカウント作成
1. [https://platform.openai.com](https://platform.openai.com) にアクセス
2. 「Sign up」をクリック
3. メールアドレスとパスワードを設定
4. メール認証を完了

#### Step 2: 支払い方法の設定
**なぜ支払い設定が必要？**
- 無料枠はありますが、継続利用には課金が必要
- 実習程度なら月$5-10程度の費用

**設定手順:**
1. ダッシュボードで「Billing」をクリック
2. 「Add payment method」を選択
3. クレジットカード情報を入力
4. 最小チャージ額（$5）を設定

#### Step 3: APIキーの生成
1. 左メニューの「API Keys」をクリック
2. 「Create new secret key」をクリック
3. 名前を設定（例：「Dify-Workshop」）
4. 生成されたキーを**必ずコピー**して保存
   - ⚠️ 一度しか表示されません！
   - 安全な場所に保管してください

### 1.4 DifyへのAI設定

#### Settings画面へのアクセス
1. Difyにログイン（http://localhost）
2. 左メニューの「設定」をクリック
3. 「モデルプロバイダー」を選択

#### OpenAIの設定
1. 「OpenAI」のカードをクリック
2. 以下を入力：
   - **API Key**: 先ほど取得したキー
   - **Organization**: 空白でOK
   - **Base URL**: 変更不要
3. 「保存」をクリック

#### 接続テスト
**設定確認方法:**
1. 「テスト」ボタンをクリック
2. 成功メッセージが表示されればOK

**エラーが出る場合:**
- APIキーの入力ミス → 再確認
- 支払い方法未設定 → OpenAIで課金設定
- API利用制限 → しばらく待ってから再試行

---

## 🤖 Phase 2: 基本チャットボットの作成

### 2.1 最初のエージェント作成

#### プロジェクト作成
1. ダッシュボードの「アプリを作成」をクリック
2. 「チャットボット」を選択
3. 以下を設定：
   - **アプリ名**: 「基本チャットボット」
   - **説明**: 「最初の練習用チャットボット」
   - **アイコン**: お好みで選択
4. 「作成」をクリック

#### 基本設定の理解
**画面構成の説明:**
- **左パネル**: 設定・管理エリア
- **中央パネル**: 会話設定エリア
- **右パネル**: テスト・プレビューエリア

### 2.2 プロンプト設計の基本

#### 効果的なプロンプトとは？
**良いプロンプトの要素:**
1. **明確な役割定義**
2. **具体的な指示**
3. **回答形式の指定**
4. **制約条件の設定**

#### 実習: 基本プロンプトの作成
**シナリオ**: 親しみやすいアシスタント

**プロンプト例:**
```
あなたは親しみやすく、丁寧なアシスタントです。

## 役割
- ユーザーの質問に正確かつわかりやすく回答する
- 常に丁寧で親しみやすい口調で話す
- わからないことは素直に「わからない」と答える

## 回答スタイル
- 簡潔で理解しやすい説明
- 必要に応じて例を含める
- 日本語で回答する

## 制約
- 不適切な内容には回答しない
- 個人情報は取り扱わない
- 推測で答えず、確実な情報のみ提供する

どのようなことでお手伝いできますか？
```

#### テストと改善
**テスト方法:**
1. 右パネルの「プレビュー」で動作確認
2. 様々な質問を試す：
   - 「こんにちは」
   - 「今日の天気を教えて」
   - 「プログラミングについて教えて」

**改善ポイント:**
- 回答が長すぎる → 「簡潔に回答してください」を追加
- 口調が硬い → 「親しみやすく」を強調
- 的外れな回答 → より具体的な指示を追加

### 2.3 モデル設定の最適化

#### モデル選択の考え方
**GPT-4 vs GPT-3.5-turbo:**

| 項目 | GPT-4 | GPT-3.5-turbo |
|------|-------|----------------|
| **精度** | 高い | 中程度 |
| **コスト** | 高い | 安い |
| **速度** | やや遅い | 速い |
| **推奨用途** | 複雑なタスク | 一般的なチャット |

**実習での推奨**: GPT-3.5-turbo（コストと性能のバランス）

#### パラメータ調整
**重要なパラメータ:**
- **Temperature（0-1）**: 創造性の度合い
  - 0.1: 一貫した回答
  - 0.7: バランス型（推奨）
  - 0.9: 創造的な回答
  
- **Max Tokens**: 最大回答長
  - 500: 短い回答
  - 1000: 中程度（推奨）
  - 2000: 長い回答

---

## 📚 Phase 3: 知識ベース活用エージェント

### 3.1 知識ベースとは？

#### 概念の理解
**従来のチャットボット:**
```
ユーザー質問 → AI → 一般的な回答
```

**知識ベース活用:**
```
ユーザー質問 → 知識ベース検索 → 関連情報取得 → AI → 専門的な回答
```

#### 知識ベースのメリット
- **正確性**: 組織の正式情報に基づく回答
- **最新性**: 情報更新が容易
- **専門性**: 特定分野に特化した深い回答

### 3.2 実習: FAQ知識ベース作成

#### シナリオ設定
**目標**: 会社のIT部門向けFAQボットを作成

#### サンプルFAQデータの準備
**テキストファイル作成（FAQ.txt）:**
```
Q: パスワードを忘れた場合はどうすればよいですか？
A: パスワードリセットは以下の手順で行えます：
1. ログイン画面の「パスワードを忘れた方」をクリック
2. 登録メールアドレスを入力
3. 送信されるメールのリンクをクリック
4. 新しいパスワードを設定
5. 設定完了後、新パスワードでログイン

Q: VPNに接続できません
A: VPN接続のトラブルシューティング：
1. インターネット接続を確認
2. VPNクライアントソフトの再起動
3. 接続設定の確認（サーバーアドレス、ユーザー名）
4. ファイアウォール設定の確認
5. それでも解決しない場合はIT部門（内線1234）へ連絡

Q: メールが送信できません
A: メール送信の問題は以下を確認してください：
1. インターネット接続の確認
2. メールサーバー設定の確認
3. 添付ファイルサイズの確認（10MB以下）
4. 送信先アドレスの確認
5. スパムフィルター設定の確認

Q: プリンターが印刷できません
A: プリンター問題の解決手順：
1. プリンターの電源確認
2. 用紙とインク/トナーの確認
3. USB/ネットワーク接続の確認
4. プリンタドライバーの再インストール
5. 印刷キューのクリア
6. プリンターの再起動
```

#### 知識ベースの作成
1. 「アプリを作成」→「チャットボット」
2. アプリ名：「IT-FAQ ボット」
3. 作成完了後、「知識ベース」タブをクリック
4. 「知識ベースを作成」をクリック
5. 以下を設定：
   - **名前**: 「IT部門FAQ」
   - **説明**: 「社内IT関連のよくある質問」
6. 「作成」をクリック

#### ドキュメントのアップロード
1. 「ドキュメントを追加」をクリック
2. 「ファイルをアップロード」を選択
3. 先ほど作成した「FAQ.txt」をアップロード
4. **処理設定**：
   - **チャンクサイズ**: 500（推奨）
   - **オーバーラップ**: 50
   - **インデックス方法**: 「高品質」
5. 「保存して処理」をクリック

**処理パラメータの意味:**
- **チャンクサイズ**: 文書を分割する単位
- **オーバーラップ**: チャンク間の重複部分
- **インデックス方法**: 検索精度の設定

#### 知識ベースの統合
1. 「チャット」タブに戻る
2. 「コンテキスト」セクションを展開
3. 「知識ベースを追加」をクリック
4. 作成したFAQ知識ベースを選択
5. **検索設定**：
   - **検索モード**: ハイブリッド検索
   - **Top K**: 3
   - **スコア閾値**: 0.5

### 3.3 専門エージェントのプロンプト設計

#### FAQ専用プロンプト
```
あなたはIT部門の専門サポートアシスタントです。

## 役割
- 社内ITに関する質問に正確に回答する
- 提供された知識ベースの情報を最優先で使用する
- 段階的で実行しやすい解決策を提示する

## 回答スタイル
- 問題解決志向の回答
- 手順は番号付きリストで明確に
- 緊急度に応じて適切な連絡先を案内
- 解決しない場合の次のステップを提示

## 制約
- 知識ベースにない情報は推測で答えない
- セキュリティに関わる詳細情報は提供しない
- 不明な場合はIT部門への連絡を推奨

## 回答形式
1. 問題の確認
2. 解決手順の提示
3. 追加情報や連絡先の案内

何かお困りのことはありますか？
```

#### テストと調整
**テスト質問例:**
- 「パスワードを忘れました」
- 「VPNが繋がりません」
- 「印刷ができません」
- 「新しいソフトをインストールしたい」（知識ベース外）

**期待する動作:**
- 知識ベース内の質問 → 詳細な手順を回答
- 知識ベース外の質問 → 「IT部門にお問い合わせください」

---

## 💼 Phase 4: 実用的なビジネスエージェント作成

### 4.1 商品案内チャットボット

#### シナリオ設定
**目標**: ECサイト向け商品案内ボット
**機能**: 商品情報提供、比較、推薦

#### 商品データベースの準備
**商品情報ファイル（products.txt）:**
```
# スマートフォン商品情報

## iPhone 15 Pro
- 価格: 159,800円
- 画面: 6.1インチ有機EL
- カメラ: 48MP トリプルカメラ
- ストレージ: 128GB/256GB/512GB/1TB
- 特徴: チタニウムボディ、Action Button搭載
- カラー: ナチュラルチタニウム、ブルーチタニウム、ホワイトチタニウム、ブラックチタニウム
- 対象: プロフェッショナル、カメラ重視ユーザー

## iPhone 15
- 価格: 124,800円
- 画面: 6.1インチ有機EL
- カメラ: 48MP デュアルカメラ
- ストレージ: 128GB/256GB/512GB
- 特徴: Dynamic Island、USB-C搭載
- カラー: ピンク、イエロー、グリーン、ブルー、ブラック
- 対象: 一般ユーザー、コストパフォーマンス重視

## Galaxy S24
- 価格: 139,800円
- 画面: 6.2インチ有機EL
- カメラ: 50MP トリプルカメラ
- ストレージ: 256GB/512GB
- 特徴: Galaxy AI搭載、7年間のアップデート保証
- カラー: オニキスブラック、マーブルグレー、コバルトバイオレット
- 対象: Android愛用者、AI機能重視

## Pixel 8
- 価格: 112,800円
- 画面: 6.2インチ有機EL
- カメラ: 50MP デュアルカメラ
- ストレージ: 128GB/256GB
- 特徴: Google純正AI機能、コスパ良好
- カラー: ローズ、ヘーゼル、オブシディアン
- 対象: Google サービス利用者、コスパ重視
```

#### エージェント設定
**アプリ作成:**
1. 「商品案内アシスタント」で新規作成
2. 知識ベースに商品情報を追加
3. 専用プロンプトを設定

**商品案内専用プロンプト:**
```
あなたは親しみやすいスマートフォン販売アシスタントです。

## 役割
- お客様のニーズに合った商品を提案する
- 商品の特徴を分かりやすく説明する
- 比較検討をサポートする
- 購入の背中を押す（過度な営業は避ける）

## 対応スタイル
- 親しみやすく、相談しやすい雰囲気
- 専門用語は分かりやすく説明
- お客様の予算と用途を重視
- 複数の選択肢を提示

## 回答パターン
### 商品紹介時
1. 主要スペックの紹介
2. おすすめポイント
3. 適合するユーザータイプ
4. 価格情報

### 比較依頼時
1. 比較表形式での整理
2. それぞれのメリット
3. 用途別おすすめ

### 質問・相談時
1. 確認質問（予算、重視ポイント等）
2. 最適な商品の提案
3. 理由の説明

いらっしゃいませ！スマートフォン選びでお困りですか？
```

#### 実践テスト
**テストシナリオ:**
1. **基本情報質問**: 「iPhone 15の価格は？」
2. **比較要求**: 「iPhone 15とPixel 8を比較して」
3. **相談型**: 「10万円以下でカメラが良いスマホは？」
4. **詳細質問**: 「Galaxy S24のAI機能って何？」

### 4.2 議事録要約アシスタント

#### シナリオ設定
**目標**: 会議の音声・テキストから要点を抽出

#### 要約特化プロンプト
```
あなたは会議議事録の要約専門アシスタントです。

## 役割
- 会議内容を構造化して整理する
- 重要なポイントを漏らさず抽出する
- 次のアクションを明確にする

## 要約形式
### 📅 会議概要
- 日時: 
- 参加者: 
- 目的: 

### 📝 主な議題と決定事項
1. 議題1
   - 討議内容: 
   - 決定事項: 
   - 担当者: 

### ✅ アクションアイテム
| 項目 | 担当者 | 期限 | ステータス |
|------|--------|------|-----------|

### 📎 補足情報
- 次回会議予定: 
- 持ち越し事項: 

## 処理ルール
- 発言者の意図を正確に把握
- 曖昧な表現は確認要求
- 個人的な雑談は除外
- 数値や固有名詞は正確に記録

会議の内容を入力してください。構造化して要約いたします。
```

#### テスト用サンプル議事録
```
【サンプル会議内容】
田中部長: それでは新製品発表会の件について話し合いましょう。予定は来月15日ですが、準備状況はいかがですか？

佐藤: マーケティング資料は80%完成しています。デザインチームとの調整が必要で、来週中には完成予定です。

山田: 会場の予約は完了しています。100名収容可能で、音響設备も問題ありません。ただし、駐車場が30台分しかないので、公共交通機関の利用を推奨します。

田中部長: プレスリリースはどうですか？

佐藤: 初稿は完成していますが、法務チェックが必要です。来週火曜日までに確認を依頼します。

田中部長: では、次回は来週金曜日に最終確認をしましょう。それまでに各自準備を完了させてください。
```

---

## 🚀 Phase 5: 高度な機能とカスタマイズ

### 5.1 ワークフロー機能の活用

#### ワークフローとは？
**チャットボット vs ワークフロー:**
- **チャットボット**: 1回の質問→1回の回答
- **ワークフロー**: 複数ステップの処理を自動化

**ワークフローの例:**
```
ユーザー入力 → データ検証 → 外部API呼び出し → 結果整形 → 回答生成
```

#### 実習: 多段階問い合わせワークフロー

**シナリオ**: 商品注文処理ワークフロー

**設計図:**
```
1. 商品選択確認
   ↓
2. 在庫チェック
   ↓
3. 配送先確認
   ↓
4. 注文確定
   ↓
5. 確認メール送信（シミュレーション）
```

#### ワークフロー作成手順
1. 「アプリを作成」→「ワークフロー」を選択
2. アプリ名：「注文処理ワークフロー」
3. ワークフロー設計画面で以下のノードを配置：

**Start ノード（開始）:**
- ユーザー入力を受け取る

**LLM ノード（商品確認）:**
```
ユーザーが選択した商品を確認し、以下の形式で整理してください：

商品名: 
数量: 
価格: 

確認できない場合は「商品情報が不足しています」と回答してください。
```

**条件分岐 ノード:**
- 商品情報が完全 → 次のステップ
- 情報不足 → 再入力要求

**LLM ノード（配送先確認）:**
```
配送先情報を確認します。以下の情報を提供してください：

- お名前
- 住所
- 電話番号
- 配送希望日時

情報が不足している項目があれば具体的に指摘してください。
```

**End ノード（完了）:**
注文処理完了メッセージ

### 5.2 APIインテグレーション

#### 外部API連携の基本

**なぜAPI連携？**
- リアルタイム情報の取得
- 外部システムとの連携
- 機能の拡張

**Difyで使える主要API:**
- **HTTP Request**: 一般的なREST API
- **Webhooks**: リアルタイム通知
- **Database**: データベース直接接続

#### 実習: 天気情報API連携

**無料天気API（OpenWeatherMap）の設定:**
1. [https://openweathermap.org](https://openweathermap.org) でアカウント作成
2. API Keyを取得
3. Difyでウェブ検索ツールまたは独自APIツールを設定

**天気情報エージェントプロンプト:**
```
あなたは天気情報を提供するアシスタントです。

## 機能
- 指定された地域の現在の天気を取得
- 週間天気予報の提供
- 服装や外出のアドバイス

## 回答形式
### 🌤️ 現在の天気
- 地域: 
- 天気: 
- 気温: 
- 湿度: 
- 風速: 

### 📅 今後の予報
- 明日: 
- 明後日: 

### 👕 おすすめ
- 服装: 
- 持ち物: 
- 外出: 

どちらの地域の天気をお調べしますか？
```

### 5.3 エージェントの公開と共有

#### 公開オプションの理解

**内部共有:**
- チーム内でのテスト
- 部門内でのパイロット運用

**外部公開:**
- ウェブサイト埋め込み
- API経由での利用
- モバイルアプリとの連携

#### ウェブサイト埋め込み設定
1. 作成したエージェントの「公開」タブをクリック
2. 「ウェブサイト埋め込み」を選択
3. 埋め込みコードをコピー
4. HTMLファイルに貼り付け

**埋め込みコード例:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>FAQ Bot Test</title>
</head>
<body>
    <h1>IT部門FAQ</h1>
    <p>何かお困りのことがあれば、下記のチャットボットにお気軽にご相談ください。</p>
    
    <!-- Dify埋め込みコード -->
    <script src="https://your-dify-domain/embed.js"></script>
    <div id="dify-chatbot" data-app-id="your-app-id"></div>
</body>
</html>
```

---

## 🧪 Phase 6: テストと改善

### 6.1 体系的なテスト方法

#### テストケースの設計

**基本機能テスト:**
- [ ] 正常な質問への回答
- [ ] 想定外の質問への対応
- [ ] 知識ベース範囲外の質問
- [ ] 不適切な質問への対応

**性能テスト:**
- [ ] 応答速度の確認
- [ ] 同時利用者数の検証
- [ ] 長時間運用の安定性

**ユーザビリティテスト:**
- [ ] 初心者でも使いやすいか
- [ ] 回答が理解しやすいか
- [ ] エラー時の案内が適切か

#### テスト実行シート
**作成したエージェント別にテスト:**

| テスト項目 | 入力内容 | 期待する回答 | 実際の回答 | 評価 | 改善点 |
|------------|----------|-------------|------------|------|--------|
| 基本機能 | パスワード忘れ | 手順案内 |  | ○/△/× |  |
| 知識外 | 経費精算方法 | 担当部門案内 |  | ○/△/× |  |
| 不適切 | 個人情報要求 | 拒否回答 |  | ○/△/× |  |

### 6.2 プロンプトエンジニアリング

#### 改善のポイント

**回答品質向上:**
```
## 改善前
簡単に回答してください。

## 改善後  
以下の形式で段階的に回答してください：
1. 問題の整理
2. 解決手順（番号付き）
3. 注意点
4. 問い合わせ先（必要時）
```

**一貫性向上:**
```
## 改善前
丁寧に答えてください。

## 改善後
回答時は必ず以下のルールを守ってください：
- 敬語を使用する
- 専門用語には説明を併記する
- 「〜です」「〜ます」調で統一する
- 感情的な表現は避ける
```

### 6.3 継続的改善の仕組み

#### ログ分析の活用
**分析すべきメトリクス:**
- 質問の傾向分析
- 回答満足度
- よくある誤回答パターン
- 応答時間の推移

#### フィードバック収集
**ユーザーフィードバックの収集方法:**
1. チャットボット内での評価ボタン
2. 定期的なアンケート
3. 利用部門からの直接フィードバック

**改善サイクル:**
```
1. データ収集
   ↓
2. 問題特定
   ↓
3. プロンプト調整
   ↓
4. A/Bテスト
   ↓
5. 本格導入
   ↓
1. に戻る
```

---

## ✅ 3日目まとめと振り返り

### 今日達成したこと

**✅ 技術習得**
- AIプロバイダーの設定完了
- 知識ベース活用方法の理解
- ワークフロー機能の基本操作
- API連携の概念理解

**✅ 実用エージェント作成**
- IT-FAQサポートボット
- 商品案内アシスタント
- 議事録要約ツール
- （各自の選択課題）

**✅ 運用スキル**
- 体系的なテスト方法
- プロンプト改善技術
- 継続的改善の仕組み

### 作成したエージェントの活用方法

**段階的導入計画:**

**Phase 1: パイロット運用**
- 限定ユーザーでのテスト
- フィードバック収集
- 初期問題の修正

**Phase 2: 部分展開**
- 特定部門・用途での本格運用
- 運用ルールの確立
- 管理体制の構築

**Phase 3: 全社展開**
- 本格的な運用開始
- 定期的な改善サイクル
- 新機能・エージェントの追加

### 明日（4日目）への準備

**オンライン版の理解に向けて:**
- [ ] 今日作成したエージェントの動作確認
- [ ] 改善したいポイントの整理
- [ ] オンライン版で試したい機能の検討
- [ ] チーム利用の想定シナリオ考案

**持参すべき成果物:**
- 作成したエージェントのスクリーンショット
- テスト結果シート
- 改善アイデアメモ
- 実用化に向けた課題リスト

### 自己評価チェックリスト

**基本操作（必須）:**
- [ ] AIプロバイダーを設定できる
- [ ] 基本的なチャットボットを作成できる
- [ ] 知識ベースを活用できる
- [ ] プロンプトを改善できる

**応用操作（推奨）:**
- [ ] ワークフローを設計できる
- [ ] 外部APIとの連携を理解している
- [ ] 体系的なテストができる
- [ ] エージェントを公開できる

**実用化準備（発展）:**
- [ ] ビジネス要件をエージェント化できる
- [ ] 継続的改善の計画を立てられる
- [ ] チーム利用の体制を考えられる
- [ ] セキュリティ要件を理解している

お疲れさまでした！明日はオンライン版でより高度な機能を学習します！

---

## 📝 課題とフィードバック

### 各自の振り返り課題

**今日の学習内容で最も印象的だったことを3つ挙げてください：**
1. 
2. 
3. 

**作成したエージェントで最も実用的だと思うものとその理由：**

**今後改善したい点・追加したい機能：**

**明日学びたいオンライン版の機能：**